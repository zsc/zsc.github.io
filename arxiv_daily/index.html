
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>今日学术速递</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", "Arial", sans-serif; line-height: 1.6; color: #333; background-color: #f8f9fa; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        h1, h2 { color: #2c3e50; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; }
        h1 { text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
        th { background-color: #f2f2f2; }
        a { color: #007bff; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .paper-title-row { cursor: pointer; transition: background-color 0.2s; }
        .paper-title-row:hover { background-color: #e9ecef; }
        .paper-title-row.expanded { background-color: #e2e6ea; }
        .paper-title { font-weight: bold; }
        .details-row { display: none; } /* Hidden by default */
        .details-row.show { display: table-row; } /* Revealed on click */
        .details-cell { padding: 20px 25px !important; background-color: #f8f9fa; }
        .authors { font-style: italic; color: #555; margin-top: 8px; display: block; }
        .abstract { margin-top: 10px; }
        #loader { text-align: center; font-size: 1.2em; padding: 50px; }
    </style>
</head>
<body>
    <div class="container" id="report-container">
        <h1>今日学术速递</h1>
        <p id="intro">正在加载和渲染论文数据... 将鼠标悬停在论文标题上可查看详细摘要。</p>
        <div id="loader">
            <p>Loading...</p>
        </div>
        <div id="clusters-content"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('clusters-content');
            const loader = document.getElementById('loader');
            const intro = document.getElementById('intro');
            const maxRetries = 7; // Maximum number of days to go back

            /**
             * Attempts to load and render data for a given date.
             * If it fails, it recursively calls itself for the previous day.
             * @param {Date} date The date to try loading data for.
             * @param {number} attempt The current attempt number (1-based).
             */
            const tryLoadData = (date, attempt = 1) => {
                if (attempt > maxRetries) {
                    loader.style.display = 'none';
                    intro.textContent = `加载最近 ${maxRetries} 天的数据失败。请检查文件是否存在以及网络连接。 (Failed to load data for the last ${maxRetries} days.)`;
                    console.error(`Failed to load data after ${maxRetries} attempts.`);
                    return;
                }

                const dateString = date.toISOString().slice(0, 10);
                const papersFile = `${dateString}.json`;
                const clustersFile = `clusters_${dateString}.json`;

                console.log(`Attempt #${attempt}: Trying to load data for ${dateString}`);

                Promise.all([
                    fetch(papersFile),
                    fetch(clustersFile)
                ])
                .then(([papersResponse, clustersResponse]) => {
                    // fetch() promise resolves on 404, so we must check the .ok status
                    if (!papersResponse.ok || !clustersResponse.ok) {
                        throw new Error(`Data not found for ${dateString}. Statuses: ${papersResponse.status}, ${clustersResponse.status}`);
                    }
                    // If files exist, return a new promise for their JSON content
                    return Promise.all([papersResponse.json(), clustersResponse.json()]);
                })
                .then(([papersData, clustersData]) => {
                    // --- SUCCESS ---
                    loader.style.display = 'none';
                    if (Object.keys(clustersData).length === 0) {
                        intro.textContent = `日期 ${dateString} 未发现相关主题的论文分组。`;
                        return;
                    }

                    intro.textContent = `为您找到日期 ${dateString} 的数据。论文已为您整理成以下 ${Object.keys(clustersData).length} 个主题。点击论文标题可展开查看摘要。`;

                    // --- Start Rendering Logic (same as before) ---
                    for (const [clusterTitle, paperIds] of Object.entries(clustersData)) {
                        const section = document.createElement('section');
                        const title = document.createElement('h2');
                        title.textContent = clusterTitle;
                        section.appendChild(title);

                        const table = document.createElement('table');
                        const thead = `<thead><tr><th>论文 (Paper)</th></tr></thead>`;
                        table.innerHTML = thead;
                        const tbody = document.createElement('tbody');

                        const papersMap = new Map(papersData.map(p => [p.id, p]));

                        paperIds.forEach(paperId => {
                            const paper = papersMap.get(paperId);
                            if (!paper) return;

                            const titleRow = tbody.insertRow();
                            titleRow.className = 'paper-title-row';
                            titleRow.innerHTML = `
                                <td>
                                    <div class="paper-title">${paper.chinese_title}</div>
                                    <div><a href="${paper.pdf_link}" target="_blank" onclick="event.stopPropagation();" title="Download PDF">${paper.title}</a></div>
                                </td>`;

                            const detailsRow = tbody.insertRow();
                            detailsRow.className = 'details-row';
                            detailsRow.innerHTML = `
                                <td class="details-cell">
                                    <strong>作者 (Authors):</strong>
                                    <div class="authors">${paper.authors}</div>
                                    <strong style="margin-top:10px; display:block;">摘要 (Abstract):</strong>
                                    <div class="abstract">${paper.chinese_abstract}</div>
                                    <div style="margin-top: 15px;">
                                        <a href="${paper.abs_link}" target="_blank">查看摘要页面 (Abs Page)</a>
                                        <a href="javascript:void(0);" class="collapse-btn" style="margin-left: 20px;">折叠 (Collapse)</a>
                                    </div>
                                </td>`;

                            titleRow.addEventListener('click', () => {
                                titleRow.classList.toggle('expanded');
                                detailsRow.classList.toggle('show');
                            });

                            const collapseBtn = detailsRow.querySelector('.collapse-btn');
                            collapseBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                titleRow.classList.remove('expanded');
                                detailsRow.classList.remove('show');
                            });
                        });
                        table.appendChild(tbody);
                        section.appendChild(table);
                        container.appendChild(section);
                    }
                    // --- End Rendering Logic ---
                })
                .catch(error => {
                    // --- FAILURE, INITIATE RETRY ---
                    console.warn(error.message); // Log the reason for this attempt's failure

                    // Calculate the previous day
                    const previousDay = new Date(date);
                    previousDay.setDate(date.getDate() - 1);

                    // Recursively call for the previous day
                    tryLoadData(previousDay, attempt + 1);
                });
            };

            // --- INITIALIZATION ---
            // Get date from URL param 'date', default to today's date
            const urlParams = new URLSearchParams(window.location.search);
            const dateParam = urlParams.get('date');
            
            // To prevent timezone issues, we create a Date object from the YYYY-MM-DD string.
            // new Date('YYYY-MM-DD') creates a date at midnight UTC.
            const initialDate = dateParam ? new Date(dateParam) : new Date();

            // Start the loading process
            tryLoadData(initialDate);
        });
    </script>
</body>
</html>
