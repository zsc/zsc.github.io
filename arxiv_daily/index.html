<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 学术速递生成器</title>
    <style>
        /* --- General & Layout --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", "Arial", sans-serif; line-height: 1.6; color: #333; background-color: #f0f2f5; margin: 0; padding: 0; }
        .container { max-width: 1000px; margin: 20px auto; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

        /* --- Config Panel --- */
        .config-panel { background-color: #f8f9fa; padding: 25px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #e9ecef; }
        .config-panel h2 { margin-top: 0; color: #2c3e50; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
        .toggle-header { cursor: pointer; user-select: none; }
        .toggle-header::after { content: ' (点击展开/折叠)'; font-size: 0.75em; color: #6c757d; font-weight: normal; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #495057; }
        .form-group input[type="text"], .form-group input[type="password"], .form-group input[type="date"], .form-group textarea {
            width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; font-size: 1rem;
        }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .btn {
            display: inline-block; padding: 12px 20px; font-size: 1rem; font-weight: bold; text-align: center; color: #fff;
            background-color: #007bff; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s;
        }
        .btn:hover { background-color: #0056b3; }
        .btn-download { background-color: #28a745; margin-left: 10px; display: none; }
        .btn-download:hover { background-color: #218838; }

        /* --- Custom Calendar --- */
        .calendar-container {
            position: relative;
            display: inline-block;
        }
        .calendar-input {
            cursor: pointer;
            background-color: white;
            user-select: none;
        }
        .calendar-input::-webkit-calendar-picker-indicator {
            display: none;
        }
        .calendar-input::-webkit-inner-spin-button,
        .calendar-input::-webkit-clear-button {
            display: none;
        }
        .calendar-widget {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 10px;
            z-index: 1000;
            display: none;
            width: 280px;
        }
        .calendar-widget.show {
            display: block;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .calendar-nav {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px 10px;
            color: #007bff;
        }
        .calendar-nav:hover {
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        .calendar-month-year {
            font-weight: bold;
            color: #2c3e50;
        }
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 5px;
        }
        .calendar-day-header {
            text-align: center;
            font-weight: bold;
            font-size: 0.8em;
            color: #6c757d;
            padding: 5px;
        }
        .calendar-day {
            text-align: center;
            padding: 8px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9em;
            position: relative;
        }
        .calendar-day:hover {
            background-color: #e9ecef;
        }
        .calendar-day.other-month {
            color: #ccc;
        }
        .calendar-day.selected {
            background-color: #007bff;
            color: white;
        }
        .calendar-day.has-report {
            font-weight: bold;
        }
        .calendar-day.has-report::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background-color: #28a745;
            border-radius: 50%;
        }
        .calendar-day.selected.has-report::after {
            background-color: white;
        }
        .calendar-day.today {
            border: 2px solid #007bff;
        }

        /* --- Mobile Responsive Calendar --- */
        @media (max-width: 768px) {
            .calendar-widget {
                width: calc(100vw - 40px);
                max-width: 350px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 16px; /* Prevent zoom on iOS */
            }
            .calendar-day {
                padding: 10px 6px;
                font-size: 0.95em;
            }
            .calendar-nav {
                padding: 8px 12px;
                font-size: 1.4em;
            }
            .calendar-day-header {
                font-size: 0.9em;
                padding: 8px 2px;
            }
        }

        @media (max-width: 480px) {
            .calendar-widget {
                width: calc(100vw - 20px);
                padding: 8px;
            }
            .calendar-days {
                gap: 1px;
            }
            .calendar-day {
                padding: 8px 4px;
            }
        }

        /* Ensure date input doesn't zoom on mobile */
        input[type="date"] {
            font-size: 16px;
        }

        /* --- Report Display --- */
        #report-container h1, #report-container h2 { color: #2c3e50; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; }
        #report-container h1 { text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
        th { background-color: #f2f2f2; }
        a { color: #007bff; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .paper-title-row { cursor: pointer; transition: background-color 0.2s; }
        .paper-title-row:hover { background-color: #e9ecef; }
        .paper-title-row.expanded { background-color: #e2e6ea; }
        .paper-title { font-weight: bold; }
        .details-row { display: none; }
        .details-row.show { display: table-row; }
        .details-cell { padding: 20px 25px !important; background-color: #f8f9fa; border-left: 3px solid #007bff; }
        .authors { font-style: italic; color: #555; margin-top: 8px; display: block; }
        .abstract { margin-top: 10px; }
        #status { text-align: center; font-size: 1.1em; padding: 20px; background-color: #e9ecef; border-radius: 5px; margin-top: 20px; display: none; }
    </style>
    <!-- Import Google Gemini JS SDK -->
    <script type="module">
        import { GoogleGenerativeAI } from 'https://esm.run/@google/generative-ai';
        window.GoogleGenerativeAI = GoogleGenerativeAI;
    </script>
</head>
<body>
    <div class="container">
        <div class="config-panel">
            <h2 class="toggle-header">配置 (Configuration)</h2>
            <div id="config-details" style="display: none;">
                <div class="form-group">
                    <label for="apiKey">Gemini API Key</label>
                    <input type="password" id="apiKey" placeholder="在此输入您的 Gemini API 密钥">
                </div>
                <div class="form-group">
                    <label for="sheetUrl">Google Sheet URL (Published to web)</label>
                    <input type="text" id="sheetUrl" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vTNzCzhuK4kdc3_-1gYqEYqKkyuhfK-hNPiNRkd0V_nsg6qaMl_1xBvcqGxCCF_oAzOolYugdvxaDIL/pubhtml">
                </div>
                <div class="form-group">
                    <label for="academicInterest">学术兴趣 (Academic Interest)</label>
                    <textarea id="academicInterest" placeholder="例如: Large language models for code generation, and agent-based AI systems"></textarea>
                </div>
            </div>
             <div class="form-group">
                <label for="reportDate">报告日期 (Report Date)</label>
                <div class="calendar-container">
                    <input type="date" id="reportDate" class="calendar-input" readonly>
                    <div id="calendarWidget" class="calendar-widget">
                        <div class="calendar-header">
                            <button class="calendar-nav" id="prevMonth">‹</button>
                            <span class="calendar-month-year" id="currentMonth"></span>
                            <button class="calendar-nav" id="nextMonth">›</button>
                        </div>
                        <div class="calendar-days" id="calendarDays"></div>
                    </div>
                </div>
            </div>
            <button id="generateBtn" class="btn">生成学术速递</button>
            <button id="downloadBtn" class="btn btn-download">下载HTML报告</button>
            <button id="debugBtn" class="btn" style="background-color: #6c757d; margin-left: 10px; display: none;">下载调试数据</button>
        </div>

        <div id="status"></div>

        <div id="report-container-wrapper">
            <!-- The generated report will be injected here -->
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const apiKeyInput = document.getElementById('apiKey');
        const sheetUrlInput = document.getElementById('sheetUrl');
        const interestInput = document.getElementById('academicInterest');
        const reportDateInput = document.getElementById('reportDate');
        const generateBtn = document.getElementById('generateBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const debugBtn = document.getElementById('debugBtn');
        const statusDiv = document.getElementById('status');
        const reportWrapper = document.getElementById('report-container-wrapper');
        const configTitle = document.querySelector('.toggle-header');
        const configDetails = document.getElementById('config-details');

        // --- Initial Setup ---
        const loadSettings = () => {
            // Allow setting API key via URL parameter, e.g., ?apiKey=...
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const apiKeyFromUrl = urlParams.get('apiKey');
                if (apiKeyFromUrl) {
                    apiKeyInput.value = apiKeyFromUrl;
                    // If key is from URL, expand the settings for visibility
                    configDetails.style.display = 'block';
                }
            } catch (e) {
                console.warn("Could not parse URL parameters.", e);
            }

            const savedInterest = localStorage.getItem('academicInterest');
            if (savedInterest) {
                interestInput.value = savedInterest;
            }
            const today = new Date();
            reportDateInput.value = createDateString(
                today.getFullYear(),
                today.getMonth() + 1,
                today.getDate()
            );
        };

        const saveSettings = () => {
            localStorage.setItem('academicInterest', interestInput.value);
        };

        // Add listener for the collapsible config panel
        configTitle.addEventListener('click', () => {
            configDetails.style.display = configDetails.style.display === 'none' ? 'block' : 'none';
        });

        // Add listener for date changes to auto-load closest report
        reportDateInput.addEventListener('change', async () => {
            const selectedDate = reportDateInput.value;
            if (selectedDate) {
                await loadClosestReport(selectedDate);
            }
        });

        // --- Core Logic ---
        const showStatus = (message, isError = false) => {
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            statusDiv.style.color = isError ? '#721c24' : '#155724';
            statusDiv.style.backgroundColor = isError ? '#f8d7da' : '#d4edda';
            statusDiv.style.borderColor = isError ? '#f5c6cb' : '#c3e6cb';
        };

        const makeReportInteractive = () => {
            const reportContainer = document.getElementById('report-container');
            if (!reportContainer) return;

            reportContainer.querySelectorAll('.paper-title-row').forEach(titleRow => {
                const detailsRow = titleRow.nextElementSibling;
                if (detailsRow && detailsRow.classList.contains('details-row')) {
                    titleRow.addEventListener('click', () => {
                        titleRow.classList.toggle('expanded');
                        detailsRow.classList.toggle('show');
                    });

                    const collapseBtn = detailsRow.querySelector('.collapse-btn');
                    if (collapseBtn) {
                        collapseBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            titleRow.classList.remove('expanded');
                            detailsRow.classList.remove('show');
                        });
                    }
                }
            });
        };
        
        // Load report from HTML format
        const loadHtmlReport = async (response, dateString) => {
            const htmlText = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');
            const loadedReportWrapper = doc.getElementById('report-container-wrapper');

            if (loadedReportWrapper && loadedReportWrapper.innerHTML.trim() !== '') {
                reportWrapper.innerHTML = loadedReportWrapper.innerHTML;
                return true;
            }
            return false;
        };
        
        // Load report from JSON format
        const loadJsonReport = async (response, dateString) => {
            try {
                const data = await response.json();
                if (data.papers && data.clusters) {
                    renderReport(data, dateString);
                    return true;
                }
            } catch (error) {
                console.error('Failed to parse JSON report:', error);
            }
            return false;
        };

        const loadLatestReport = async (maxDays = 5) => {
            const today = new Date();
            showStatus(`正在查找最新报告...`);
            
            // Check recent dates sequentially (today, yesterday, etc.)
            for (let i = 0; i < maxDays; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateString = createDateString(
                    date.getFullYear(),
                    date.getMonth() + 1,
                    date.getDate()
                );
                
                // Try JSON format first, then HTML format
                const formats = [
                    { ext: 'json', loader: loadJsonReport },
                    { ext: 'html', loader: loadHtmlReport }
                ];
                
                for (const format of formats) {
                    const url = format.ext === 'json' 
                        ? `${dateString.replace(/-/g, '')}.json`  // 20250801.json format
                        : `academic-digest-${dateString}.html`;   // academic-digest-2025-08-01.html format
                    
                    try {
                        // Fast HEAD request to check existence first
                        const headResponse = await fetch(url, { method: 'HEAD' });
                        if (headResponse.ok) {
                            // File exists, now load the content
                            const cacheOption = isGeneratingReport ? 'no-cache' : 'default';
                            const response = await fetch(url, { cache: cacheOption });
                            if (response.ok) {
                                const loaded = await format.loader(response, dateString);
                                if (loaded) {
                                    const dayLabel = i === 0 ? '今日' : i === 1 ? '昨日' : `${i}天前`;
                                    showStatus(`已成功加载${dayLabel}报告 (${dateString})。`, false);
                                    downloadBtn.style.display = 'inline-block';
                                    makeReportInteractive();
                                    
                                    // Update date input to reflect loaded report
                                    reportDateInput.value = dateString;
                                    
                                    return true;
                                }
                            }
                        }
                    } catch (error) {
                        console.warn(`无法加载报告 ${url}:`, error);
                    }
                }
            }
            return false;
        };

        const loadClosestReport = async (targetDate, searchRange = 30) => {
            const targetDateObj = parseDateString(targetDate);
            const targetTime = targetDateObj.getTime();
            
            // Try exact date first with both formats
            showStatus(`正在查找 ${targetDate} 的报告...`);
            
            const formats = [
                { ext: 'json', loader: loadJsonReport },
                { ext: 'html', loader: loadHtmlReport }
            ];
            
            for (const format of formats) {
                const exactUrl = format.ext === 'json'
                    ? `${targetDate.replace(/-/g, '')}.json`
                    : `academic-digest-${targetDate}.html`;
                    
                try {
                    const cacheOption = isGeneratingReport ? 'no-cache' : 'default';
                    const response = await fetch(exactUrl, { cache: cacheOption });
                    if (response.ok || response.status === 304) {
                        const loaded = await format.loader(response, targetDate);
                        if (loaded) {
                            showStatus(`已成功加载 ${targetDate} 的报告。`, false);
                            downloadBtn.style.display = 'inline-block';
                            makeReportInteractive();
                            return true;
                        }
                    }
                } catch (error) {
                    console.warn(`无法加载报告 ${exactUrl}:`, error);
                }
            }

            // Search for closest date within range
            showStatus(`未找到 ${targetDate} 的报告，正在搜索最近的报告...`);
            let closestDate = null;
            let closestDiff = Infinity;
            let closestFormat = null;

            // Check dates before and after the target date
            for (let i = 1; i <= searchRange; i++) {
                // Check date before
                const dateBefore = new Date(targetTime);
                dateBefore.setDate(dateBefore.getDate() - i);
                const dateBeforeString = createDateString(
                    dateBefore.getFullYear(),
                    dateBefore.getMonth() + 1,
                    dateBefore.getDate()
                );
                
                // Check date after
                const dateAfter = new Date(targetTime);
                dateAfter.setDate(dateAfter.getDate() + i);
                const dateAfterString = createDateString(
                    dateAfter.getFullYear(),
                    dateAfter.getMonth() + 1,
                    dateAfter.getDate()
                );

                // Try both dates with both formats
                for (const [dateString, date] of [[dateBeforeString, dateBefore], [dateAfterString, dateAfter]]) {
                    for (const format of formats) {
                        const url = format.ext === 'json'
                            ? `${dateString.replace(/-/g, '')}.json`
                            : `academic-digest-${dateString}.html`;
                            
                        try {
                            const response = await fetch(url, { cache: 'no-cache' });
                            if (response.ok || response.status === 304) {
                                const diff = Math.abs(date.getTime() - targetTime);
                                if (diff < closestDiff) {
                                    closestDiff = diff;
                                    closestDate = dateString;
                                    closestFormat = format;
                                }
                            }
                        } catch (error) {
                            // Continue searching
                        }
                    }
                }
            }

            // Load the closest report found
            if (closestDate && closestFormat) {
                const url = closestFormat.ext === 'json'
                    ? `${closestDate.replace(/-/g, '')}.json`
                    : `academic-digest-${closestDate}.html`;
                    
                try {
                    const cacheOption = isGeneratingReport ? 'no-cache' : 'default';
                    const response = await fetch(url, { cache: cacheOption });
                    if (response.ok || response.status === 304) {
                        const loaded = await closestFormat.loader(response, closestDate);
                        if (loaded) {
                            const daysDiff = Math.round(closestDiff / (1000 * 60 * 60 * 24));
                            showStatus(`未找到 ${targetDate} 的报告，已加载最接近的报告 (${closestDate}，相差 ${daysDiff} 天)。`, false);
                            downloadBtn.style.display = 'inline-block';
                            makeReportInteractive();
                            return true;
                        }
                    }
                } catch (error) {
                    console.error(`无法加载报告 ${url}:`, error);
                }
            }

            showStatus(`未找到 ${targetDate} 附近的任何报告。请尝试生成新报告。`, true);
            return false;
        };

        const hideStatus = () => {
            statusDiv.style.display = 'none';
        };

        // Calendar functionality
        let availableDates = new Set();
        let currentCalendarDate = new Date();
        let selectedDate = new Date();
        let isGeneratingReport = false; // Track when generating new reports

        // Helper function to create date string consistently
        const createDateString = (year, month, day) => {
            const padZero = (num) => String(num).padStart(2, '0');
            return `${year}-${padZero(month)}-${padZero(day)}`;
        };

        // Helper function to parse date string to local date
        const parseDateString = (dateString) => {
            if (!dateString) return new Date();
            const [year, month, day] = dateString.split('-').map(num => parseInt(num, 10));
            return new Date(year, month - 1, day);
        };

        const scanAvailableDates = async () => {
            const dates = new Set();
            const promises = [];
            
            // Reduced scope: scan only past 14 days for background prefetch
            for (let i = 0; i <= 14; i++) {
                const checkDate = new Date();
                checkDate.setDate(checkDate.getDate() - i);
                const dateString = createDateString(
                    checkDate.getFullYear(),
                    checkDate.getMonth() + 1,
                    checkDate.getDate()
                );
                
                // Check both HTML and JSON formats
                promises.push(
                    fetch(`academic-digest-${dateString}.html`, { method: 'HEAD' })
                        .then(response => {
                            if (response.ok || response.status === 304) {
                                dates.add(dateString);
                            }
                        })
                        .catch(() => {})
                );
                
                promises.push(
                    fetch(`${dateString.replace(/-/g, '')}.json`, { method: 'HEAD' })
                        .then(response => {
                            if (response.ok || response.status === 304) {
                                dates.add(dateString);
                            }
                        })
                        .catch(() => {})
                );
            }
            
            await Promise.all(promises);
            availableDates = dates;
            
            // Only re-render calendar if it's currently visible
            const calendarWidget = document.getElementById('calendarWidget');
            if (calendarWidget && calendarWidget.classList.contains('show')) {
                renderCalendar();
            }
        };

        const renderCalendar = () => {
            const calendarDays = document.getElementById('calendarDays');
            const currentMonthElement = document.getElementById('currentMonth');
            
            // Clear calendar
            calendarDays.innerHTML = '';
            
            // Set month/year display
            const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
            currentMonthElement.textContent = `${currentCalendarDate.getFullYear()}年 ${monthNames[currentCalendarDate.getMonth()]}`;
            
            // Add day headers
            const dayHeaders = ['日', '一', '二', '三', '四', '五', '六'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                calendarDays.appendChild(header);
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
            const prevLastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 0);
            
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const todayDate = new Date();
            const today = createDateString(
                todayDate.getFullYear(),
                todayDate.getMonth() + 1,
                todayDate.getDate()
            );
            const selectedDateString = reportDateInput.value || today;
            
            // Generate 42 days (6 weeks)
            for (let i = 0; i < 42; i++) {
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = cellDate.getDate();
                
                // Use consistent date string creation to avoid timezone issues
                const cellDateString = createDateString(
                    cellDate.getFullYear(),
                    cellDate.getMonth() + 1,
                    cellDate.getDate()
                );
                
                // Add classes
                if (cellDate.getMonth() !== currentCalendarDate.getMonth()) {
                    dayElement.classList.add('other-month');
                }
                if (cellDateString === today) {
                    dayElement.classList.add('today');
                }
                if (cellDateString === selectedDateString) {
                    dayElement.classList.add('selected');
                }
                if (availableDates.has(cellDateString)) {
                    dayElement.classList.add('has-report');
                }
                
                // Add click handler
                dayElement.addEventListener('click', () => {
                    reportDateInput.value = cellDateString;
                    reportDateInput.dispatchEvent(new Event('change'));
                    document.getElementById('calendarWidget').classList.remove('show');
                });
                
                calendarDays.appendChild(dayElement);
            }
        };

        // Calendar navigation
        document.getElementById('prevMonth').addEventListener('click', (e) => {
            e.preventDefault();
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', (e) => {
            e.preventDefault();
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        });

        // Show calendar on focus (handles both click and tab)
        reportDateInput.addEventListener('focus', (e) => {
            const calendarWidget = document.getElementById('calendarWidget');
            if (!calendarWidget.classList.contains('show')) {
                if (reportDateInput.value) {
                    currentCalendarDate = parseDateString(reportDateInput.value);
                }
                calendarWidget.classList.add('show');
                renderCalendar();
            }
        });

        // Prevent default date picker on click
        reportDateInput.addEventListener('click', (e) => {
            e.preventDefault();
            reportDateInput.blur(); // Remove focus to prevent native date picker
            reportDateInput.focus(); // Re-focus to show our calendar
        });

        // Hide calendar when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.calendar-container')) {
                document.getElementById('calendarWidget').classList.remove('show');
            }
        });

        // Also handle touch events for mobile
        document.addEventListener('touchstart', (e) => {
            if (!e.target.closest('.calendar-container')) {
                document.getElementById('calendarWidget').classList.remove('show');
            }
        });
        
        const fetchAndParseGoogleSheet = async (url) => {
            showStatus('1/5: 正在抓取 Google Sheet 数据...');
            
            try {
                // Extract the published sheet ID from the URL
                const sheetIdMatch = url.match(/\/d\/e\/([^\/]+)/);
                if (!sheetIdMatch) throw new Error('无法从URL中提取Sheet ID');
                const sheetId = sheetIdMatch[1];
                
                // First, fetch the main page to get the sheet mapping
                const mainUrl = `https://docs.google.com/spreadsheets/d/e/${sheetId}/pubhtml`;
                const mainProxyUrl = `https://corsproxy.io/?${encodeURIComponent(mainUrl)}`;
                
                showStatus('正在获取可用的数据表列表...');
                const mainResponse = await fetch(mainProxyUrl);
                if (!mainResponse.ok) throw new Error(`无法获取主页面，服务器响应: ${mainResponse.status}`);
                
                const mainHtml = await mainResponse.text();
                
                // Extract all sheet information from the JavaScript in the page
                const itemsMatch = mainHtml.match(/var items = \[\];(.+?)var sheetsViewport/s);
                if (!itemsMatch) throw new Error('无法从页面中提取数据表信息');
                
                // Parse the sheet items
                const sheetItems = [];
                const itemRegex = /name: "([^"]+)".*?gid: "(\d+)"/g;
                let match;
                while ((match = itemRegex.exec(itemsMatch[1])) !== null) {
                    sheetItems.push({
                        name: match[1],
                        gid: match[2]
                    });
                }
                
                if (sheetItems.length === 0) throw new Error('未找到任何数据表');
                
                // Get the date from the report date input
                const selectedDate = reportDateInput.value;
                let targetSheet = null;
                
                if (selectedDate) {
                    // Try to find exact match for selected date
                    targetSheet = sheetItems.find(item => item.name === selectedDate);
                }
                
                // If no exact match or no date selected, try to find the most recent sheet
                if (!targetSheet) {
                    // Get today's date
                    const today = new Date();
                    const todayString = createDateString(
                        today.getFullYear(),
                        today.getMonth() + 1,
                        today.getDate()
                    );
                    
                    // Try to find today's sheet first
                    targetSheet = sheetItems.find(item => item.name === todayString);
                    
                    // If not found, find the most recent sheet
                    if (!targetSheet) {
                        // Sort sheets by date (newest first)
                        const sortedSheets = sheetItems.sort((a, b) => {
                            return new Date(b.name) - new Date(a.name);
                        });
                        targetSheet = sortedSheets[0];
                    }
                }
                
                if (!targetSheet) throw new Error('无法确定要使用的数据表');
                
                showStatus(`2/5: 正在获取 ${targetSheet.name} 的数据...`);
                
                // Fetch the specific sheet using its GID
                const sheetUrl = `https://docs.google.com/spreadsheets/d/e/${sheetId}/pubhtml/sheet?headers=false&gid=${targetSheet.gid}`;
                const sheetProxyUrl = `https://corsproxy.io/?${encodeURIComponent(sheetUrl)}`;
                
                const sheetResponse = await fetch(sheetProxyUrl);
                if (!sheetResponse.ok) throw new Error(`无法获取数据表，服务器响应: ${sheetResponse.status}`);
                
                const sheetHtml = await sheetResponse.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(sheetHtml, 'text/html');
                
                // Find the table with class 'waffle'
                const table = doc.querySelector('.waffle');
                if (!table) throw new Error(`在 ${targetSheet.name} 的数据中未找到表格`);
                
                showStatus(`3/5: 正在解析 ${targetSheet.name} 的表格数据...`);
                const papers = parseTableData(table);
                
                if (!papers || papers.length === 0) {
                    throw new Error(`${targetSheet.name} 的表格中没有找到论文数据`);
                }
                
                showStatus(`已成功获取 ${targetSheet.name} 的数据 (${papers.length} 篇论文)`);
                return papers;
                
            } catch (error) {
                showStatus(`抓取或解析失败: ${error.message}`, true);
                console.error(error);
                return null;
            }
        };
        
        // Helper function to parse table data
        const parseTableData = (table) => {
            const papers = [];
            const rows = table.querySelectorAll('tbody tr');
            
            // Skip header row and freezebar row
            for (let i = 0; i < rows.length; i++) {
                // Skip rows that are freezebar cells
                if (rows[i].querySelector('.freezebar-cell')) continue;
                
                const cells = rows[i].querySelectorAll('td');
                if (cells.length < 7) continue; // Ensure row has enough data
                
                // Skip header row by checking if first cell contains "ID"
                if (cells[0].textContent.trim() === 'ID') continue;
                
                const paper = {
                    id: cells[0].textContent.trim(),
                    title: cells[1].textContent.trim(),
                    authors: cells[2].textContent.trim(),
                    subjects: cells[3].textContent.trim(),
                    abstract: cells[4].textContent.trim(),
                    abs_link: cells[5].querySelector('a')?.href || '',
                    pdf_link: cells[6].querySelector('a')?.href || ''
                };
                
                // Only add papers with a valid arXiv ID and title
                if (paper.id && paper.id.startsWith('arXiv:') && paper.title) {
                    papers.push(paper);
                }
            }
            
            return papers;
        };

        // Global variable to store debug data
        let debugData = null;
        
        const processWithGemini = async (papers, interest, apiKey) => {
            showStatus(`4/5: 已提取 ${papers.length} 篇论文，正在调用 Gemini AI 进行筛选、翻译和聚类...`);
            
            if (!window.GoogleGenerativeAI) {
                showStatus('Gemini AI SDK未能加载。请检查网络连接或浏览器控制台。', true);
                return null;
            }

            try {
                const genAI = new window.GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ model: "gemini-2.5-pro" });

                const prompt = `
You are an expert academic research assistant. I will provide you with a list of arXiv papers in a JSON array.
Your task is to perform the following steps and return a single, valid JSON object as your response. Do not add any text before or after the JSON block.

My primary academic interest is: "${interest}"

Here are the tasks:
1.  From the provided list, select the top 20 most relevant and highest-quality papers related to my academic interest.
2.  For EACH of these 20 selected papers, you MUST perform two translations:
    a. Translate the English "title" into Chinese.
    b. Translate the English "abstract" into Chinese.
3.  Based on the content of these 20 papers, group them into 3 to 5 thematic clusters. The cluster titles should be concise and in Chinese.
4.  Structure your final output as a single valid JSON object with two top-level keys: "papers" and "clusters".

The required JSON output format is EXACTLY as follows:
{
  "papers": [
    {
      "id": "The original paper ID, e.g., 'arXiv:2401.12345'",
      "title": "The original English title of the paper",
      "chinese_title": "Your Chinese translation of the title",
      "authors": "The original authors string",
      "abs_link": "The original abstract page link",
      "pdf_link": "The original PDF link",
      "chinese_abstract": "Your detailed Chinese translation of the abstract."
    }
  ],
  "clusters": {
    "一个简洁的中文聚类标题 1": ["id_of_paper_1", "id_of_paper_2"],
    "另一个简洁的中文聚类标题 2": ["id_of_paper_3", "id_of_paper_4", "id_of_paper_5"],
    "简洁的中文聚类标题 3": ["id_of_paper_6", "id_of_paper_7"]
  }
}

Now, process the following list of papers:
${JSON.stringify(papers)}
`;

                // Store debug data
                debugData = {
                    papers: papers,
                    interest: interest,
                    fullPrompt: prompt,
                    timestamp: new Date().toISOString()
                };
                
                // Show debug button
                document.getElementById('debugBtn').style.display = 'inline-block';

                const result = await model.generateContent(prompt);
                const responseText = result.response.text();
                
                // Clean the response to ensure it's valid JSON
                const jsonString = responseText.trim().replace(/^```json\s*|```$/g, '');
                const data = JSON.parse(jsonString);
                
                if (!data.papers || !data.clusters) {
                    throw new Error("Gemini返回的JSON格式不正确，缺少'papers'或'clusters'键。");
                }
                
                return data;

            } catch(error) {
                showStatus(`Gemini AI 处理失败: ${error.message}. 请检查API Key和浏览器控制台。`, true);
                console.error("Gemini Error:", error);
                return null;
            }
        };

        const renderReport = (data, dateString) => {
            showStatus('5/5: 正在渲染报告...');

            const { papers: papersData, clusters: clustersData } = data;
            
            let html = `
                <div class="container" id="report-container">
                    <h1>今日学术速递 (${dateString})</h1>
                    <p id="intro">为您找到日期 ${dateString} 的数据。论文已为您整理成以下 ${Object.keys(clustersData).length} 个主题。点击论文标题可展开查看摘要。</p>
                    <div id="clusters-content">`;

            const papersMap = new Map(papersData.map(p => [p.id, p]));

            for (const [clusterTitle, paperIds] of Object.entries(clustersData)) {
                html += `
                    <section>
                        <h2>${clusterTitle}</h2>
                        <table>
                            <thead><tr><th>论文 (Paper)</th></tr></thead>
                            <tbody>`;
                
                paperIds.forEach(paperId => {
                    const paper = papersMap.get(paperId);
                    if (!paper) {
                        console.warn(`Paper ID ${paperId} found in clusters but not in paper list.`);
                        return;
                    }
                    html += `
                        <tr class="paper-title-row">
                            <td>
                                <div class="paper-title">${paper.chinese_title}</div>
                                <div><a href="${paper.pdf_link}" target="_blank" onclick="event.stopPropagation();" title="Download PDF">${paper.id} - ${paper.title}</a></div>
                            </td>
                        </tr>
                        <tr class="details-row">
                            <td class="details-cell">
                                <strong>作者 (Authors):</strong>
                                <div class="authors">${paper.authors}</div>
                                <strong style="margin-top:10px; display:block;">摘要 (Abstract):</strong>
                                <div class="abstract">${paper.chinese_abstract.replace(/\n/g, '<br>')}</div>
                                <div style="margin-top: 15px;">
                                    <a href="${paper.abs_link}" target="_blank">查看摘要页面 (Abs Page)</a>
                                    <a href="javascript:void(0);" class="collapse-btn" style="margin-left: 20px;">折叠 (Collapse)</a>
                                </div>
                            </td>
                        </tr>`;
                });

                html += `
                            </tbody>
                        </table>
                    </section>`;
            }

            html += `</div></div>`;
            reportWrapper.innerHTML = html;

            makeReportInteractive();
            hideStatus();
            downloadBtn.style.display = 'inline-block';
            
            // Refresh calendar to show new available date
            scanAvailableDates();
        };

        const downloadReport = () => {
            const reportHTML = document.getElementById('report-container-wrapper').outerHTML;
            const styles = document.querySelector('style').innerHTML;
            const date = reportDateInput.value || new Date().toISOString().slice(0, 10);

            const interactiveScript = `
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.paper-title-row').forEach(titleRow => {
                const detailsRow = titleRow.nextElementSibling;
                if (detailsRow) {
                    titleRow.addEventListener('click', () => {
                        titleRow.classList.toggle('expanded');
                        detailsRow.classList.toggle('show');
                    });
                    const collapseBtn = detailsRow.querySelector('.collapse-btn');
                    if (collapseBtn) {
                        collapseBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            titleRow.classList.remove('expanded');
                            detailsRow.classList.remove('show');
                        });
                    }
                }
            });
        });`;
            
            const fullHtml = `
                <!DOCTYPE html>
                <html lang="zh-CN">
                <head>
                    <meta charset="UTF-8">
                    <title>学术速递 - ${date}</title>
                    <style>${styles}</style>
                </head>
                <body>
                    ${reportHTML}
                    <script>${interactiveScript}<\/script>
                </body>
                </html>`;
            
            const blob = new Blob([fullHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `academic-digest-${date}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        const initializePage = async () => {
            loadSettings(); // Load user settings from localStorage first
            
            // Priority: Load latest report first for immediate display
            showStatus('正在查找最新的学术速递报告...');
            const wasLoaded = await loadLatestReport(5); // Try loading for last 5 days

            if (!wasLoaded) {
                // Keep the status message, but make it an "error" style to be more prominent
                showStatus('未找到近期报告。请配置并生成新报告。', true);
            }
            
            // Background: Scan for available dates for the calendar (non-blocking)
            setTimeout(() => {
                scanAvailableDates();
            }, 100);
        };

        // --- Main Event Handler ---
        generateBtn.addEventListener('click', async () => {
            // Reset UI
            reportWrapper.innerHTML = '';
            downloadBtn.style.display = 'none';

            // Get and validate inputs
            const apiKey = apiKeyInput.value.trim();
            const sheetUrl = sheetUrlInput.value.trim();
            const interest = interestInput.value.trim();
            const reportDate = reportDateInput.value;

            if (!apiKey || !sheetUrl || !interest) {
                showStatus('请填写 Gemini API Key, Google Sheet URL, 和您的学术兴趣。', true);
                return;
            }
            saveSettings();
            generateBtn.disabled = true;
            
            // Set generation flag to bypass cache for new reports
            isGeneratingReport = true;

            const rawPapers = await fetchAndParseGoogleSheet(sheetUrl);
            if (rawPapers) {
                const processedData = await processWithGemini(rawPapers, interest, apiKey);
                if (processedData) {
                    renderReport(processedData, reportDate);
                }
            }
            
            // Reset generation flag
            isGeneratingReport = false;
            generateBtn.disabled = false;
        });

        downloadBtn.addEventListener('click', downloadReport);
        
        // Debug button handler
        debugBtn.addEventListener('click', () => {
            if (!debugData) {
                showStatus('没有调试数据可下载', true);
                return;
            }
            
            // Create a formatted text file with the complete prompt
            const debugContent = `=== GEMINI API 调试数据 ===
生成时间: ${debugData.timestamp}
论文数量: ${debugData.papers.length}

=== 学术兴趣 ===
${debugData.interest}

=== 完整的 Gemini Prompt (可直接复制使用) ===
${debugData.fullPrompt}

=== 原始论文数据 (JSON格式) ===
${JSON.stringify(debugData.papers, null, 2)}
`;
            
            const blob = new Blob([debugContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gemini-debug-${debugData.timestamp.replace(/[:.]/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus('调试数据已下载', false);
        });
        
        initializePage();
    });

    </script>
</body>
</html>
