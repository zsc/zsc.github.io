<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Changed title to reflect 28x28 -->
    <title>Diffusion Model Training Demo (MNIST 28x28)</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        label { display: block; margin-top: 10px; font-weight: bold;}
        input[type="number"], input[type="text"], select {
            width: calc(100% - 22px); padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;
        }
        button {
            background-color: #007bff; color: white; padding: 10px 15px; border: none;
            border-radius: 4px; cursor: pointer; margin-top: 20px; font-size: 16px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        #logs {
            margin-top: 20px; padding: 10px; border: 1px solid #ddd; height: 300px;
            overflow-y: scroll; background-color: #e9e9e9; white-space: pre-wrap;
            font-family: monospace; font-size: 0.9em;
        }
        /* Styles for multiple sample images */
        #sampleImageContainer { 
            margin-top: 20px; 
            display: flex; /* Use flexbox to arrange images */
            flex-wrap: wrap; /* Allow images to wrap to next line */
            gap: 10px; /* Space between images */
        }
        .sample-image-item { /* Style for individual image */
            border: 1px solid #ddd; 
            max-width: 100px; /* Adjust size as needed for 28x28, can be larger */
            max-height: 100px;
            image-rendering: pixelated; /* Keep pixels sharp */
            background-color: #f0f0f0; /* Placeholder bg */
        }
        .status { margin-top: 10px; font-weight: bold; }
        .error { color: red; }
        .success { color: green; }
        .hyperparam-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .hyperparam-item { display: flex; flex-direction: column; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Changed title -->
        <h1>Diffusion Model Training (MNIST 28x28)</h1>

        <div class="hyperparam-grid">
            <div class="hyperparam-item">
                <label for="learning_rate">Learning Rate:</label>
                <input type="number" id="learning_rate" value="0.0001" step="0.00001"> <!-- Adjusted default LR -->
            </div>
            <div class="hyperparam-item">
                <label for="epochs">Epochs:</label>
                <input type="number" id="epochs" value="20" min="1"> <!-- Increased default epochs for 28x28 -->
            </div>
            <div class="hyperparam-item">
                <label for="batch_size">Batch Size:</label>
                <input type="number" id="batch_size" value="64" min="1"> <!-- May need to reduce for GPU memory with 28x28 -->
            </div>
            <div class="hyperparam-item">
                <label for="timesteps">Diffusion Timesteps (T):</label>
                <input type="number" id="timesteps" value="200" min="10">
            </div>
            <div class="hyperparam-item">
                <label for="unet_n_channels">U-Net Base Channels (n_channels):</label>
                <input type="number" id="unet_n_channels" value="32" min="8">
            </div>
            <div class="hyperparam-item">
                <label for="unet_ch_mults">U-Net Channel Multipliers (e.g., 1,2,2):</label>
                <input type="text" id="unet_ch_mults" value="1,2,2"> <!-- Default good for 28x28 (28->14->7) -->
            </div>
             <div class="hyperparam-item">
                <label for="limit_dataset_size">Limit Dataset Size (for faster demo):</label>
                <input type="number" id="limit_dataset_size" value="10000" min="100"> <!-- Increased for better 28x28 training -->
            </div>
        </div>

        <button id="startTrainingBtn">Start Training</button>
        <button id="generateSampleBtn" disabled>Generate 5 Samples</button> <!-- Updated button text -->
        
        <div id="statusMessage" class="status"></div>

        <h2>Training Logs:</h2>
        <div id="logs"></div>

        <h2>Generated Samples:</h2>
        <!-- Container for multiple images -->
        <div id="sampleImageContainer">
            <!-- Images will be added here by JavaScript -->
        </div>
        <p id="noSampleText">No samples generated yet. Train a model first.</p>
    </div>

    <script>
        const startTrainingBtn = document.getElementById('startTrainingBtn');
        const generateSampleBtn = document.getElementById('generateSampleBtn');
        const logsDiv = document.getElementById('logs');
        // Get the container for sample images, not a single image element
        const sampleImageContainer = document.getElementById('sampleImageContainer'); 
        const noSampleText = document.getElementById('noSampleText');
        const statusMessageDiv = document.getElementById('statusMessage');
        let logInterval;

        function displayStatus(message, isError = false) {
            statusMessageDiv.textContent = message;
            statusMessageDiv.className = 'status ' + (isError ? 'error' : 'success');
        }

        function appendLog(message) {
            logsDiv.innerHTML += message + '\n';
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        async function fetchLogs() {
            try {
                const response = await fetch('/get_logs');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                logsDiv.innerHTML = ''; 
                data.logs.forEach(log => appendLog(log));
            } catch (error) {
                console.error('Error fetching logs:', error);
                appendLog('Error fetching logs: ' + error.message);
            }
        }

        startTrainingBtn.addEventListener('click', async () => {
            const hyperparams = {
                learning_rate: parseFloat(document.getElementById('learning_rate').value),
                epochs: parseInt(document.getElementById('epochs').value),
                batch_size: parseInt(document.getElementById('batch_size').value),
                timesteps: parseInt(document.getElementById('timesteps').value),
                unet_n_channels: parseInt(document.getElementById('unet_n_channels').value),
                unet_ch_mults: document.getElementById('unet_ch_mults').value.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n)),
                limit_dataset_size: parseInt(document.getElementById('limit_dataset_size').value)
            };

            startTrainingBtn.disabled = true;
            generateSampleBtn.disabled = true;
            sampleImageContainer.innerHTML = ''; // Clear previous images
            noSampleText.style.display = 'block'; // Show "no sample" text
            displayStatus('Starting training...', false);
            logsDiv.innerHTML = '';

            try {
                const response = await fetch('/start_training', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(hyperparams)
                });
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    displayStatus('Training started. Check logs.', false);
                    logInterval = setInterval(async () => {
                        await fetchLogs();
                        if (logsDiv.textContent.includes("Training finished.") || logsDiv.textContent.includes("Training aborted.")) {
                            clearInterval(logInterval);
                            startTrainingBtn.disabled = false;
                            generateSampleBtn.disabled = false;
                            displayStatus(logsDiv.textContent.includes("Training finished.") ? 'Training finished.' : 'Training aborted/failed.', false);
                        }
                    }, 2000);
                } else {
                    displayStatus('Error starting training: ' + (data.message || 'Unknown error'), true);
                    startTrainingBtn.disabled = false;
                }
            } catch (error) {
                displayStatus('Network error starting training: ' + error.message, true);
                startTrainingBtn.disabled = false;
            }
        });

        generateSampleBtn.addEventListener('click', async () => {
            generateSampleBtn.disabled = true;
            displayStatus('Generating samples...', false);
            sampleImageContainer.innerHTML = ''; // Clear previous images
            noSampleText.style.display = 'block';

            try {
                const response = await fetch('/generate_sample');
                const data = await response.json();
                // Expect 'image_data_list'
                if (response.ok && data.status === 'success' && data.image_data_list) {
                    data.image_data_list.forEach(imgDataBase64 => {
                        const imgElement = document.createElement('img');
                        imgElement.src = 'data:image/png;base64,' + imgDataBase64;
                        imgElement.alt = 'Generated Sample';
                        imgElement.classList.add('sample-image-item'); // Add class for styling
                        sampleImageContainer.appendChild(imgElement);
                    });
                    noSampleText.style.display = 'none'; // Hide "no sample" text
                    displayStatus(`${data.image_data_list.length} samples generated.`, false);
                } else {
                    displayStatus('Error generating samples: ' + (data.message || 'Unknown error'), true);
                }
            } catch (error) {
                displayStatus('Network error generating samples: ' + error.message, true);
            } finally {
                generateSampleBtn.disabled = false;
            }
        });
        
        fetchLogs(); 
    </script>
</body>
</html>
