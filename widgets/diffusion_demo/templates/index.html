<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiT Diffusion Model Demo (MNIST 28x28)</title> <!-- MODIFIED TITLE -->
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        label { display: block; margin-top: 10px; font-weight: bold;}
        input[type="number"], input[type="text"], select {
            width: calc(100% - 22px); padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;
        }
        button {
            background-color: #007bff; color: white; padding: 10px 15px; border: none;
            border-radius: 4px; cursor: pointer; margin-top: 20px; font-size: 16px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        #logs {
            margin-top: 20px; padding: 10px; border: 1px solid #ddd; height: 300px;
            overflow-y: scroll; background-color: #e9e9e9; white-space: pre-wrap;
            font-family: monospace; font-size: 0.9em;
        }
        #sampleImageContainer { 
            margin-top: 20px; 
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .sample-image-item {
            border: 1px solid #ddd; 
            width: 56px; /* Slightly larger for 28x28 to be visible */
            height: 56px;
            image-rendering: pixelated;
            background-color: #f0f0f0;
        }
        .status { margin-top: 10px; font-weight: bold; }
        .error { color: red; }
        .success { color: green; }
        .hyperparam-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .hyperparam-item { display: flex; flex-direction: column; }
    </style>
</head>
<body>
    <div class="container">
        <h1>DiT Diffusion Model Training (MNIST 28x28)</h1> <!-- MODIFIED TITLE -->

        <div class="hyperparam-grid">
            <div class="hyperparam-item">
                <label for="learning_rate">Learning Rate:</label>
                <input type="number" id="learning_rate" value="0.0001" step="0.00001">
            </div>
            <div class="hyperparam-item">
                <label for="epochs">Epochs:</label>
                <input type="number" id="epochs" value="20" min="1">
            </div>
            <div class="hyperparam-item">
                <label for="batch_size">Batch Size:</label>
                <input type="number" id="batch_size" value="32" min="1"> <!-- Potentially smaller for DiT -->
            </div>
            <div class="hyperparam-item">
                <label for="timesteps">Diffusion Timesteps (T):</label>
                <input type="number" id="timesteps" value="200" min="10">
            </div>
            <!-- DiT Specific Parameters -->
            <div class="hyperparam-item">
                <label for="patch_size">Patch Size (e.g., 4 for 28x28):</label>
                <input type="number" id="patch_size" value="4" min="1">
            </div>
            <div class="hyperparam-item">
                <label for="hidden_size">DiT Hidden Size (Embedding Dim):</label>
                <input type="number" id="hidden_size" value="192" min="32" step="16"> <!-- Smaller default -->
            </div>
            <div class="hyperparam-item">
                <label for="depth">DiT Depth (Num Blocks):</label>
                <input type="number" id="depth" value="6" min="1"> <!-- Smaller default -->
            </div>
            <div class="hyperparam-item">
                <label for="num_heads">DiT Num Heads:</label>
                <input type="number" id="num_heads" value="3" min="1"> <!-- Corresponds to hidden_size 192/3=64 per head -->
            </div>
             <div class="hyperparam-item">
                <label for="time_emb_dim">Time Embedding Dim (often = Hidden Size):</label>
                <input type="number" id="time_emb_dim" value="192" min="32" step="16"> <!-- Tie to hidden_size -->
            </div>
            <div class="hyperparam-item">
                <label for="limit_dataset_size">Limit Dataset Size:</label>
                <input type="number" id="limit_dataset_size" value="10000" min="100">
            </div>
        </div>

        <button id="startTrainingBtn">Start DiT Training</button> <!-- MODIFIED BUTTON TEXT -->
        <button id="generateSampleBtn" disabled>Generate 5 Samples</button>
        
        <div id="statusMessage" class="status"></div>

        <h2>Training Logs:</h2>
        <div id="logs"></div>

        <h2>Generated Samples:</h2>
        <div id="sampleImageContainer"></div>
        <p id="noSampleText">No samples generated yet. Train a DiT model first.</p> <!-- MODIFIED TEXT -->
    </div>

    <script>
        const startTrainingBtn = document.getElementById('startTrainingBtn');
        const generateSampleBtn = document.getElementById('generateSampleBtn');
        const logsDiv = document.getElementById('logs');
        const sampleImageContainer = document.getElementById('sampleImageContainer'); 
        const noSampleText = document.getElementById('noSampleText');
        const statusMessageDiv = document.getElementById('statusMessage');
        let logInterval;

        // Function to update time_emb_dim based on hidden_size
        function updateTimeEmbDim() {
            const hiddenSizeVal = document.getElementById('hidden_size').value;
            document.getElementById('time_emb_dim').value = hiddenSizeVal;
        }
        // Add event listener to hidden_size input
        document.getElementById('hidden_size').addEventListener('input', updateTimeEmbDim);
        // Initial call to set it
        updateTimeEmbDim();


        function displayStatus(message, isError = false) {
            statusMessageDiv.textContent = message;
            statusMessageDiv.className = 'status ' + (isError ? 'error' : 'success');
        }

        function appendLog(message) {
            logsDiv.innerHTML += message + '\n';
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        async function fetchLogs() {
            try {
                const response = await fetch('/get_logs');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                logsDiv.innerHTML = ''; 
                data.logs.forEach(log => appendLog(log));
            } catch (error) {
                console.error('Error fetching logs:', error);
                appendLog('Error fetching logs: ' + error.message);
            }
        }

        startTrainingBtn.addEventListener('click', async () => {
            // Collect DiT hyperparameters
            const hyperparams = {
                learning_rate: parseFloat(document.getElementById('learning_rate').value),
                epochs: parseInt(document.getElementById('epochs').value),
                batch_size: parseInt(document.getElementById('batch_size').value),
                timesteps: parseInt(document.getElementById('timesteps').value),
                patch_size: parseInt(document.getElementById('patch_size').value),
                hidden_size: parseInt(document.getElementById('hidden_size').value),
                depth: parseInt(document.getElementById('depth').value),
                num_heads: parseInt(document.getElementById('num_heads').value),
                time_emb_dim: parseInt(document.getElementById('time_emb_dim').value),
                limit_dataset_size: parseInt(document.getElementById('limit_dataset_size').value)
            };

            startTrainingBtn.disabled = true;
            generateSampleBtn.disabled = true;
            sampleImageContainer.innerHTML = ''; 
            noSampleText.style.display = 'block'; 
            displayStatus('Starting DiT training...', false); // MODIFIED
            logsDiv.innerHTML = '';

            try {
                const response = await fetch('/start_training', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(hyperparams)
                });
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    displayStatus('DiT Training started. Check logs.', false); // MODIFIED
                    logInterval = setInterval(async () => {
                        await fetchLogs();
                        const logText = logsDiv.textContent;
                        if (logText.includes("Training finished.") || logText.includes("Training aborted.") || logText.includes("Error:")) {
                            clearInterval(logInterval);
                            startTrainingBtn.disabled = false;
                            generateSampleBtn.disabled = false;
                            let finalMessage = 'Training finished.';
                            if (logText.includes("Training aborted.")) finalMessage = 'Training aborted.';
                            if (logText.includes("Error:")) finalMessage = 'Training failed. Check logs.';
                            displayStatus(finalMessage, logText.includes("Error:") || logText.includes("aborted."));
                        }
                    }, 2000);
                } else {
                    displayStatus('Error starting DiT training: ' + (data.message || 'Unknown error'), true); // MODIFIED
                    startTrainingBtn.disabled = false;
                }
            } catch (error) {
                displayStatus('Network error starting DiT training: ' + error.message, true); // MODIFIED
                startTrainingBtn.disabled = false;
            }
        });

        generateSampleBtn.addEventListener('click', async () => {
            generateSampleBtn.disabled = true;
            displayStatus('Generating samples with DiT...', false); // MODIFIED
            sampleImageContainer.innerHTML = ''; 
            noSampleText.style.display = 'block';

            try {
                const response = await fetch('/generate_sample');
                const data = await response.json();
                if (response.ok && data.status === 'success' && data.image_data_list) {
                    data.image_data_list.forEach(imgDataBase64 => {
                        const imgElement = document.createElement('img');
                        imgElement.src = 'data:image/png;base64,' + imgDataBase64;
                        imgElement.alt = 'Generated DiT Sample'; // MODIFIED
                        imgElement.classList.add('sample-image-item'); 
                        sampleImageContainer.appendChild(imgElement);
                    });
                    noSampleText.style.display = 'none'; 
                    displayStatus(`${data.image_data_list.length} DiT samples generated.`, false); // MODIFIED
                } else {
                    displayStatus('Error generating DiT samples: ' + (data.message || 'Unknown error'), true); // MODIFIED
                }
            } catch (error) {
                displayStatus('Network error generating DiT samples: ' + error.message, true); // MODIFIED
            } finally {
                generateSampleBtn.disabled = false;
            }
        });
        
        fetchLogs(); 
    </script>
</body>
</html>
