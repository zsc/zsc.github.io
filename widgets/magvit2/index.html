<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>18-bit/9-bit Grid Converter</title>
    <style>
        :root {
            --bg-color: #f4f4f9;
            --panel-bg: #ffffff;
            --border: #ddd;
            --primary: #007bff;
            --text: #333;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text);
            height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        h2 { margin-top: 0; font-size: 1.1rem; color: #444; margin-bottom: 10px; }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            background: var(--panel-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            align-items: center;
            flex-wrap: wrap;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .control-group label {
            font-size: 0.9rem;
            font-weight: 600;
        }
        input[type="number"], select {
            padding: 4px 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            height: 30px;
            box-sizing: border-box;
        }
        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .container {
            display: flex;
            gap: 20px;
            flex: 1;
            min-height: 0; 
        }
        .box {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--panel-bg);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            min-width: 0; /* Prevent flex item overflow */
        }
        textarea {
            flex: 1;
            width: 100%;
            resize: none;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 10px;
            font-size: 14px;
            line-height: 1.5;
            box-sizing: border-box;
            outline: none;
        }
        textarea:focus {
            border-color: var(--primary);
        }
        
        #inputNumbers {
            font-family: 'Consolas', 'Monaco', monospace;
            color: #2a2a2a;
        }
        
        #outputGrid {
            font-family: 'SimSun', 'Songti SC', serif; 
            white-space: pre; /* 重要：保持换行 */
            overflow-x: auto;
            font-size: 16px;
            line-height: 1.5; 
        }

        .status-bar {
            margin-left: auto;
            font-size: 0.85rem;
            color: #666;
        }
    </style>
</head>
<body>

    <div class="controls">
        <div class="control-group">
            <label>高度 (H):</label>
            <input type="number" id="heightVal" value="64" style="width: 60px;">
        </div>
        <div class="control-group">
            <label>宽度 (W):</label>
            <input type="number" id="widthVal" value="96" style="width: 60px;">
        </div>
        <div class="control-group">
            <label>采样:</label>
            <select id="sampleSelect">
                <option value="8">8x8</option>
                <option value="16">16x16</option>
            </select>
        </div>
        
        <div style="width: 1px; height: 20px; background: #ddd; margin: 0 5px;"></div>

        <div class="control-group" style="background: #eef5ff; padding: 4px 8px; border-radius: 4px; border: 1px solid #cce5ff;">
            <input type="checkbox" id="isSplitMode">
            <label for="isSplitMode" style="cursor: pointer; color: #0056b3;">输入已拆分为 9-bit</label>
        </div>

        <div class="status-bar">
            0 = "啊" (GB2312)
        </div>
    </div>

    <div class="container">
        <div class="box">
            <h2>数字数组 (JSON Array)</h2>
            <textarea id="inputNumbers" placeholder="[ ... ]"></textarea>
        </div>
        <div class="box">
            <h2>汉字矩阵 (Visual Grid)</h2>
            <textarea id="outputGrid" placeholder="生成的汉字..." spellcheck="false"></textarea>
        </div>
    </div>

<script>
    // --- 1. GB2312 Table Generation (前 512 个汉字) ---
    const charMap = [];     // Index -> Char
    const valMap = {};      // Char -> Index

    function initGB2312() {
        const decoder = new TextDecoder('gb2312');
        let count = 0;
        // GB2312 一级字库从 16区 (0xB0) 开始
        for (let row = 0xB0; row <= 0xF7; row++) {
            for (let col = 0xA1; col <= 0xFE; col++) {
                if (count >= 512) return;
                const bytes = new Uint8Array([row, col]);
                const char = decoder.decode(bytes);
                charMap.push(char);
                valMap[char] = count;
                count++;
            }
        }
    }
    initGB2312();

    // --- 2. DOM Elements ---
    const els = {
        numInput: document.getElementById('inputNumbers'),
        charInput: document.getElementById('outputGrid'),
        hVal: document.getElementById('heightVal'),
        wVal: document.getElementById('widthVal'),
        sample: document.getElementById('sampleSelect'),
        splitMode: document.getElementById('isSplitMode')
    };

    let isUpdating = false;

    // 默认数据 (18-bit)
    const defaultData = [
        235523, 252795, 256595, 258579, 252518, 121870, 245623, 257059, 255042, 119589, 121419, 254475, 
        244299, 130566, 101218, 117248, 120602, 240060, 131071, 96218, 126662, 243713, 117319, 258651, 
        121611, 123998, 128655, 246750, 252522, 18167, 74170, 121341, 102524, 236986, 244290, 253527, 
        112079, 116529, 97529, 102543, 259242, 78771, 225835, 220778, 222970, 110799, 98371, 260670, 
        255784, 17805, 35247, 34045, 152298, 116173, 43307, 177339, 230741, 250298, 108619, 260871, 
        127355, 5372, 152187, 61215, 112296, 18940, 216123, 226046, 1253, 242746, 239683, 130586, 
        236330, 253435, 90844, 196603, 259193, 86773, 127422, 85244, 126397, 119715, 250457, 232270, 
        252527, 255923, 70911, 79034, 159641, 22203, 153133, 181183, 50348, 130906, 260623, 252419
    ];

    // --- 3. 核心逻辑 ---

    function getLayoutConfig() {
        const H = parseInt(els.hVal.value) || 64;
        const W = parseInt(els.wVal.value) || 96;
        const S = parseInt(els.sample.value) || 8;
        
        // 逻辑块数量 (Logical Blocks)
        const logicalCols = Math.floor(W / S); // 例如 96/8 = 12
        
        // 视觉字符宽度 (Visual Chars)
        // 1个逻辑块 = 2个汉字宽度 (因为 18-bit 是 2字，或 2个 9-bit 是 2字)
        const charsPerRow = logicalCols * 2; 

        return { charsPerRow };
    }

    // 左 -> 右：数字 转 汉字
    function numbersToText() {
        if (isUpdating) return;
        isUpdating = true;

        try {
            const raw = els.numInput.value;
            if (!raw.trim()) {
                els.charInput.value = "";
                return;
            }

            const nums = JSON.parse(raw);
            if (!Array.isArray(nums)) throw new Error("Input not array");

            const isSplit = els.splitMode.checked;
            const { charsPerRow } = getLayoutConfig();

            let result = "";
            let lineBuffer = "";
            let charsInLine = 0;

            // 辅助函数：追加字符并处理换行
            const appendChar = (char) => {
                lineBuffer += char;
                charsInLine++;
                if (charsInLine >= charsPerRow) {
                    result += lineBuffer + "\n";
                    lineBuffer = "";
                    charsInLine = 0;
                }
            };

            if (isSplit) {
                // Mode: 9-bit (1 number = 1 char)
                nums.forEach(n => {
                    const idx = parseInt(n);
                    const c = charMap[idx & 0x1FF] || '？'; // Protect against >511
                    appendChar(c);
                });
            } else {
                // Mode: 18-bit (1 number = 2 chars)
                nums.forEach(n => {
                    const val = parseInt(n);
                    const high = (val >> 9) & 0x1FF;
                    const low = val & 0x1FF;
                    appendChar(charMap[high] || '？');
                    appendChar(charMap[low] || '？');
                });
            }

            if (lineBuffer) result += lineBuffer;
            els.charInput.value = result;

        } catch (e) {
            console.warn("Parse error or partial input:", e);
        } finally {
            isUpdating = false;
        }
    }

    // 右 -> 左：汉字 转 数字
    function textToNumbers() {
        if (isUpdating) return;
        isUpdating = true;

        try {
            const rawText = els.charInput.value;
            // 提取有效字符
            const validChars = [];
            for (let char of rawText) {
                if (valMap.hasOwnProperty(char)) {
                    validChars.push(char);
                }
            }

            const isSplit = els.splitMode.checked;
            const nums = [];

            if (isSplit) {
                // Mode: 9-bit (1 char = 1 number)
                validChars.forEach(c => {
                    nums.push(valMap[c]);
                });
            } else {
                // Mode: 18-bit (2 chars = 1 number)
                for (let i = 0; i < validChars.length; i += 2) {
                    if (i + 1 >= validChars.length) break; // 忽略末尾不成对的
                    const high = valMap[validChars[i]];
                    const low = valMap[validChars[i+1]];
                    nums.push((high << 9) | low);
                }
            }

            // 格式化 JSON 输出 (为了美观，进行换行)
            const { charsPerRow } = getLayoutConfig();
            // 在 JSON 中换行的频率：
            // 9-bit模式: 每行 charsPerRow 个数字
            // 18-bit模式: 每行 charsPerRow/2 个数字
            const itemsPerLine = isSplit ? charsPerRow : (charsPerRow / 2);

            let jsonStr = "[\n";
            let rowTemp = [];
            
            nums.forEach((n, idx) => {
                rowTemp.push(n);
                if (rowTemp.length >= itemsPerLine) {
                    jsonStr += "  " + rowTemp.join(", ") + (idx === nums.length - 1 ? "" : ",") + "\n";
                    rowTemp = [];
                }
            });
            if (rowTemp.length > 0) {
                jsonStr += "  " + rowTemp.join(", ") + "\n";
            }
            jsonStr += "]";

            els.numInput.value = jsonStr;

        } catch (e) {
            console.error(e);
        } finally {
            isUpdating = false;
        }
    }

    // --- 4. 事件监听 ---

    els.numInput.addEventListener('input', numbersToText);
    els.charInput.addEventListener('input', textToNumbers);

    function refreshLayout() {
        // 当布局改变时，我们希望保持数据不变，重新排版汉字
        // 这里触发 numbersToText 即可
        const temp = isUpdating;
        isUpdating = false;
        numbersToText();
        isUpdating = temp;
    }

    function toggleMode() {
        // 当切换模式时，我们认为“汉字矩阵”(右侧)是用户看到的真相
        // 所以我们根据当前的汉字，重新计算左侧的数字格式
        // 这样可以实现数据在 18-bit 和 9-bit 数组之间的转换
        textToNumbers();
    }

    els.hVal.addEventListener('change', refreshLayout);
    els.wVal.addEventListener('change', refreshLayout);
    els.sample.addEventListener('change', refreshLayout);
    
    // Checkbox 切换时，执行转换
    els.splitMode.addEventListener('change', toggleMode);

    // 初始化
    els.numInput.value = JSON.stringify(defaultData);
    numbersToText(); // 初始渲染

</script>
</body>
</html>
