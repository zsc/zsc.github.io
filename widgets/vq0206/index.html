<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Tag <-> GB2312 Matrix Converter</title>
    <style>
        body {
            font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
            background-color: #f4f4f9;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
        }

        h2 {
            margin-bottom: 20px;
        }

        .container {
            display: flex;
            gap: 20px;
            width: 100%;
            height: 100%;
            max-width: 1200px;
        }

        .box {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
        }

        textarea {
            width: 100%;
            flex: 1;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            white-space: pre; 
            overflow: auto;
        }

        #inputAudio {
            white-space: pre-wrap;  /* 允许自动换行 */
            word-break: break-all;  /* 强制打断长字符串（因为 audio 标签中间通常没空格） */
        }

        textarea:focus {
            outline: none;
            border-color: #66afe9;
            box-shadow: 0 0 8px rgba(102, 175, 233, 0.6);
        }

        .note {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
            background: #e9e9e9;
            padding: 10px;
            border-radius: 5px;
            width: 100%;
            max-width: 1200px;
        }
    </style>
</head>
<body>

    <h2>Audio 标签 / GB2312 竖排矩阵转换器</h2>

    <div class="container">
        <div class="box">
            <label for="inputAudio">Audio 标签输入 (线性流)</label>
            <textarea id="inputAudio" spellcheck="false"></textarea>
        </div>
        <div class="box">
            <label for="inputText">汉字矩阵 (5行，竖向排列)</label>
            <textarea id="inputText" spellcheck="false"></textarea>
        </div>
    </div>

    <div class="note">
        <strong>规则：</strong> 
        1. ID 0 映射为 GB2312 第一个汉字 "啊"。
        2. Audio 序列每 5 个一组，在右侧变为一列（即：第1个字在第1行，第2个字在第2行...）。
        3. 左右输入框实时互转。
    </div>

<script>
    // ==========================================
    // 1. 初始化 GB2312 字符集
    // ==========================================
    const gbChars = [];
    const charToIdMap = new Map();

    function initGB2312() {
        const decoder = new TextDecoder('gbk'); // GBK 兼容 GB2312
        
        // GB2312 范围：
        // 一级汉字：16-55区 (0xB0 - 0xD7)
        // 二级汉字：56-87区 (0xD8 - 0xF7)
        // 每个区有 94 个位 (0xA1 - 0xFE)
        
        // 为了确保 0 = "啊" (0xB0A1)，我们需要严格按照顺序生成
        
        const ranges = [
            { start: 0xB0, end: 0xD7 }, // Level 1
            { start: 0xD8, end: 0xF7 }  // Level 2
        ];

        let index = 0;

        ranges.forEach(range => {
            for (let b1 = range.start; b1 <= range.end; b1++) {
                for (let b2 = 0xA1; b2 <= 0xFE; b2++) {
                    const buffer = new Uint8Array([b1, b2]);
                    const char = decoder.decode(buffer);
                    
                    // 存入数组
                    gbChars.push(char);
                    // 建立反向索引 (如果字符重复，保留第一个索引)
                    if (!charToIdMap.has(char)) {
                        charToIdMap.set(char, index);
                    }
                    index++;
                }
            }
        });
        
        console.log(`GB2312 table loaded. Total chars (including potential blanks): ${gbChars.length}`);
        console.log(`Index 0: ${gbChars[0]} (Should be 啊)`);
    }

    initGB2312();

    // ==========================================
    // 2. 转换逻辑
    // ==========================================

    const audioInput = document.getElementById('inputAudio');
    const textInput = document.getElementById('inputText');

    // 默认输入字符串
    const defaultInput = `<audio_735><audio_735><audio_2021><audio_1060><audio_4482><audio_883><audio_779><audio_1097><audio_3284><audio_1695><audio_475><audio_475><audio_1326><audio_1057><audio_1227><audio_682><audio_682><audio_1367><audio_1879><audio_4274><audio_759><audio_759><audio_4274><audio_2635><audio_1535><audio_547><audio_512><audio_2315><audio_1154><audio_3264><audio_205><audio_205><audio_2357><audio_1872><audio_1542><audio_682><audio_682><audio_2284><audio_1072><audio_4274><audio_245><audio_504><audio_2635><audio_1535><audio_3358><audio_504><audio_851><audio_2540><audio_2004><audio_2427><audio_194><audio_194><audio_1148><audio_1065><audio_4659><audio_866><audio_512><audio_1367><audio_2579><audio_3900><audio_725><audio_725><audio_1986><audio_3715><audio_4631><audio_725><audio_441><audio_3561><audio_2608><audio_2608><audio_754><audio_76><audio_1513><audio_2140><audio_3270><audio_631><audio_304><audio_3175><audio_1210><audio_4922><audio_935><audio_631><audio_4922><audio_4922><audio_2470><audio_747><audio_747><audio_2470><audio_2758><audio_1371><audio_973><audio_866><audio_1371><audio_1108><audio_2037><audio_846><audio_620><audio_1966><audio_2540><audio_2160><audio_846><audio_866><audio_1445><audio_1133><audio_1070><audio_781><audio_781><audio_5080><audio_2907><audio_1062><audio_594><audio_594><audio_1295><audio_4130><audio_3186><audio_866><audio_18><audio_3274><audio_4145><audio_1560><audio_393><audio_393><audio_4636><audio_1353><audio_3607><audio_866><audio_718><audio_1725><audio_1594><audio_4624><audio_800><audio_238><audio_4624><audio_2097><audio_2603><audio_238><audio_936><audio_2907><audio_1456><audio_2537><audio_790><audio_433><audio_2820><audio_1063><audio_2540><audio_813><audio_936><audio_2718><audio_2051><audio_3839><audio_754><audio_85><audio_1456><audio_3644><audio_2042><audio_631><audio_304><audio_2317><audio_3988><audio_3708><audio_935><audio_596><audio_4673><audio_2141><audio_2141><audio_920><audio_576><audio_1041><audio_1797><audio_1797><audio_856><audio_369><audio_1392><audio_2531><audio_1724><audio_809><audio_361><audio_2265><audio_1805><audio_1069><audio_87><audio_87><audio_1371><audio_4289><audio_3423><audio_866><audio_76><audio_2247><audio_1217><audio_2054><audio_85><audio_76><audio_3061><audio_1041><audio_2470><audio_631><audio_304><audio_2470><audio_2470><audio_2470><audio_169><audio_707><audio_1455><audio_3086><audio_3086><audio_707><audio_950><audio_4302><audio_3670><audio_2315><audio_898><audio_698><audio_1083><audio_3578><audio_2917><audio_698><audio_950><audio_4792><audio_1052><audio_3175><audio_698><audio_507><audio_3950><audio_4145><audio_2985><audio_507><audio_18><audio_4253><audio_1535><audio_1826><audio_134><audio_134><audio_1084><audio_4578><audio_3277><audio_866><audio_512><audio_1433><audio_2042><audio_3900><audio_514><audio_514><audio_2276><audio_1072><audio_3561><audio_866><audio_476><audio_1535><audio_1604><audio_2141><audio_631><audio_383><audio_2141><audio_2141><audio_2141>`;

    // Audio String -> Matrix Text
    function convertAudioToText() {
        const rawStr = audioInput.value;
        const regex = /<audio_(\d+)>/g;
        let match;
        const ids = [];
        
        // 提取所有数字
        while ((match = regex.exec(rawStr)) !== null) {
            ids.push(parseInt(match[1], 10));
        }

        if (ids.length === 0) {
            textInput.value = "";
            return;
        }

        // 准备 5 行的数组
        const rows = [[], [], [], [], []];

        // 填充矩阵 (竖排逻辑：元素依次填入 row 0, row 1, ... row 4, 然后回到 row 0)
        ids.forEach((id, index) => {
            const rowIndex = index % 5;
            let char = "？"; // 默认错误符
            if (id >= 0 && id < gbChars.length) {
                char = gbChars[id];
            }
            rows[rowIndex].push(char);
        });

        // 拼接成字符串，用换行符分隔
        textInput.value = rows.map(row => row.join("")).join("\n");
    }

    // Matrix Text -> Audio String
    function convertTextToAudio() {
        const rawText = textInput.value;
        const lines = rawText.split("\n");
        
        // 确保有 5 行，不足补空
        while (lines.length < 5) lines.push("");
        // 截断多余的行 (只取前5行)
        const processLines = lines.slice(0, 5);

        // 找出最长的一行，决定列数
        let maxLen = 0;
        processLines.forEach(line => {
            if (line.length > maxLen) maxLen = line.length;
        });

        const resultAudio = [];

        // 按列扫描
        for (let col = 0; col < maxLen; col++) {
            for (let row = 0; row < 5; row++) {
                const line = processLines[row];
                // 检查该行是否有这一列
                if (col < line.length) {
                    const char = line[col];
                    // 查找 ID
                    let id = charToIdMap.get(char);
                    
                    if (id === undefined) {
                        // 如果找不到或者是空格等，处理逻辑
                        // 这里我们简单跳过或标记 -1，或者保留原样？
                        // 为了保持结构，如果不认识的字，我们假设它是 ID 0 ('啊') 或者报错
                        // 这里选择输出一个特殊的 audio_0 表示 fallback
                        // 或者如果它是不可见字符且不在库中，忽略
                        if(char.trim() === '') continue; // 忽略空格
                        id = 0; 
                    }
                    resultAudio.push(`<audio_${id}>`);
                }
            }
        }

        audioInput.value = resultAudio.join("");
    }

    // ==========================================
    // 3. 事件监听
    // ==========================================

    let isSyncing = false;

    audioInput.addEventListener('input', () => {
        if (isSyncing) return;
        isSyncing = true;
        convertAudioToText();
        isSyncing = false;
    });

    textInput.addEventListener('input', () => {
        if (isSyncing) return;
        isSyncing = true;
        convertTextToAudio();
        isSyncing = false;
    });

    // 初始化
    window.addEventListener('DOMContentLoaded', () => {
        audioInput.value = defaultInput;
        convertAudioToText();
    });

</script>

</body>
</html>
